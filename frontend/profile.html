<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Profile</title>
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="css/reset.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/profile.css" rel="stylesheet">
    <link href="css/toast.css" rel="stylesheet">
</head>
<body>
<div class="wrapper">
    <header class="header">
        <img alt="" aria-hidden="true" class="hero-bg"
             src="img/profile/header/scenic-view-sky-sunrise_1048944-27468973.avif">
        <div class="logout-container">
            <button aria-label="Выйти" class="btn-log-out" id="logout-btn" type="button">
                <img alt="" src="img/profile/header/logout.png"/>
            </button>
        </div>
    </header>
    <main class="container profile-page">
        <section aria-labelledby="user‑name" class="profile-info">
            <figure class="profile-photo">
                <img alt="Аватар пользователя" height="128" loading="lazy"
                     src="img/profile/main/profile/profile avatar.png"
                     width="128">
            </figure>
            <dl class="profile-details">
                <dt>Имя</dt>
                <dd id="profile-username"></dd>
                <dd class="actions">
                    <button aria-label="Изменить имя"
                            class="btn-edit"
                            data-field="username"
                            type="button">Изменить
                    </button>
                </dd>

                <dt>Электронная&nbsp;почта</dt>
                <dd id="profile-email"></dd>
                <dd class="actions">
                    <button aria-label="Изменить электронную почту"
                            class="btn-edit"
                            data-field="email"
                            type="button">Изменить
                    </button>
                </dd>

                <dt>Дата&nbsp;рождения</dt>
                <dd id="profile-birthdate"></dd>
                <dd class="actions">
                    <button aria-label="Изменить дату рождения"
                            class="btn-edit"
                            data-field="birthdate"
                            type="button">Изменить
                    </button>
                </dd>
            </dl>
        </section>
        <section class="cart">
            <h2 class="section-title cart-heading" id="cart-title">Корзина</h2>
            <hr aria-hidden="true" class="section-divider">
            <ul class="orders-list" id="orders-list"></ul>
            <div class="no-orders" id="no-orders">
                <p class="no-orders__text">У&nbsp;вас&nbsp;пока&nbsp;нет&nbsp;заказов</p>
                <div class="no-orders__plus"></div>
            </div>
        </section>
        <div aria-hidden="true" class="hidden" id="modal">
            <div aria-modal="true" class="modal__dialog" role="dialog">
                <h2 class="modal__title">Добавить товар</h2>

                <label class="modal__label">
                    Товар:
                    <select class="modal__select" id="product-select"></select>
                </label>

                <label class="modal__label">
                    Кол‑во:
                    <input autocomplete="off" class="modal__input" id="qty-input" inputmode="numeric" type="text">
                </label>

                <p class="modal__total" id="total-price">Итого: —</p>

                <div class="modal__actions">
                    <button class="modal__btn modal__btn_cancel" id="cancel-btn">Отмена</button>
                    <button class="modal__btn modal__btn_ok" disabled id="confirm-btn">Добавить</button>
                </div>
            </div>
        </div>

        <div aria-hidden="true" class="hidden" id="profile-modal">
            <div aria-modal="true" class="modal__dialog" role="dialog">
                <h2 class="modal__title" id="profile-modal-title"></h2>

                <label class="modal__label" id="profile-modal-label">
                </label>

                <div class="modal__actions">
                    <button class="modal__btn modal__btn_cancel" id="profile-cancel">Отмена</button>
                    <button class="modal__btn modal__btn_ok" disabled id="profile-save">Сохранить</button>
                </div>
            </div>
        </div>

        <!-- Модальное окно для информации о товаре -->
        <div aria-hidden="true" class="hidden" id="product-info-modal">
            <div aria-modal="true" class="product-modal__dialog" role="dialog">
                <button class="product-modal__close" id="product-info-close" aria-label="Закрыть">
                    <svg width="24" height="24" viewBox="0 0 24 24">
                        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                
                <div class="product-modal__content">
                    <div class="product-modal__image">
                        <img id="product-info-image" src="" alt="">
                    </div>
                    <div class="product-modal__info">
                        <h2 class="product-modal__title" id="product-info-name"></h2>
                        <p class="product-modal__price" id="product-info-price"></p>
                        <p class="product-modal__quantity">Количество: <span id="product-info-quantity"></span></p>
                        <div class="product-modal__total">
                            Общая стоимость: <span id="product-info-total"></span>
                        </div>
                    </div>
                </div>

                <div class="product-modal__actions">
                    <button class="product-modal__btn product-modal__btn_edit" id="product-edit-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        Редактировать
                    </button>
                    <button class="product-modal__btn product-modal__btn_delete" id="product-delete-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24">
                            <path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        Удалить
                    </button>
                </div>
            </div>
        </div>

        <!-- Модальное окно для редактирования товара -->
        <div aria-hidden="true" class="hidden" id="product-edit-modal">
            <div aria-modal="true" class="modal__dialog" role="dialog">
                <h2 class="modal__title">Редактировать товар</h2>

                <div class="edit-product__info">
                    <img id="edit-product-image" src="" alt="" class="edit-product__image">
                    <div class="edit-product__details">
                        <h3 id="edit-product-name"></h3>
                        <p id="edit-product-price"></p>
                    </div>
                </div>

                <label class="modal__label">
                    Количество:
                    <input autocomplete="off" class="modal__input" id="edit-qty-input" inputmode="numeric" type="text" min="1">
                </label>

                <p class="modal__total" id="edit-total-price">Итого: —</p>

                <div class="modal__actions">
                    <button class="modal__btn modal__btn_cancel" id="edit-cancel-btn">Отмена</button>
                    <button class="modal__btn modal__btn_ok" disabled id="edit-save-btn">Сохранить</button>
                </div>
            </div>
        </div>

    </main>

    <footer class="footer">
        <div class="footer__top">
            <div class="footer-branding">
                <h2 class="footer__logo"><a href="#">GREENMIND</a></h2>
                <p class="footer__tagline">We help you find your dream plant</p>
                <ul class="footer__social">
                    <li><a class="social__link" href="#"><img alt=""
                                                              src="/frontend/img/index/footer/social/Group_11.svg"></a>
                    </li>
                    <li><a class="social__link" href="#"><img alt=""
                                                              src="/frontend/img/index/footer/social/Group_12.svg"></a>
                    </li>
                    <li><a class="social__link" href="#"><img alt=""
                                                              src="/frontend/img/index/footer/social/Group_13.svg"></a>
                    </li>
                </ul>
            </div>
            <div class="footer__nav">
                <ul class="footer__nav-list">
                    <li class="footer__nav-item non-clickable">Information</li>
                    <li class="footer__nav-item"><a href="#">About</a></li>
                    <li class="footer__nav-item"><a href="#">Product</a></li>
                    <li class="footer__nav-item"><a href="#">Blog</a></li>
                </ul>
                <ul class="footer__nav-list">
                    <li class="footer__nav-item non-clickable">Company</li>
                    <li class="footer__nav-item"><a href="#">Community</a></li>
                    <li class="footer__nav-item"><a href="#">Career</a></li>
                    <li class="footer__nav-item"><a href="#">Our story</a></li>
                </ul>
                <ul class="footer__nav-list">
                    <li class="footer__nav-item non-clickable">Contact</li>
                    <li class="footer__nav-item"><a href="#">Getting Started</a></li>
                    <li class="footer__nav-item"><a href="#">Pricing</a></li>
                    <li class="footer__nav-item"><a href="#">Resources</a></li>
                </ul>
            </div>
        </div>
        <div class="footer__legal">
            <small>2023 all Right Reserved Term of use GREENMIND</small>
        </div>
    </footer>

    <!-- Контейнер для Toast уведомлений -->
    <div id="toast-container"></div>

    <!-- Подключение утилит -->
    <script src="js/utils/security.js"></script>
    <script src="js/utils/toast.js"></script>
    <script src="js/utils/api.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const data = await ApiHelper.get('/api/profile');
                
                document.getElementById('profile-username').textContent = data.username || '';
                document.getElementById('profile-email').textContent = data.email || '';
                document.getElementById('profile-birthdate').textContent = data.birthDate || '';
                renderOrders(Array.isArray(data.orders) ? data.orders : []);
                
                Toast.success('Профиль загружен');
            } catch (e) {
                console.error('Failed to load profile:', e);
                // ApiHelper уже показал Toast с ошибкой
            }
        });

        document.getElementById('logout-btn')
            .addEventListener('click', async () => {
                await fetch('/logout', {method: 'POST', credentials: 'same-origin'});
                window.location.href = '/index.html';
            });

        const listElm = document.getElementById('orders-list');
        const noOrdersEl = document.getElementById('no-orders');

        function renderOrders(orders) {
            listElm.innerHTML = '';
            if (!orders.length) {
                noOrdersEl.style.display = 'flex';
                return;
            }
            noOrdersEl.style.display = 'none';

            orders.forEach(o => {
                const li = document.createElement('li');
                li.className = 'order-card';
                li.innerHTML = `
                    <img class="order-card__img" 
                         src="${o.imagePath || '/img/placeholder.png'}" 
                         alt="${o.productName}"
                         data-product-id="${o.productId || o.id || ''}"
                         data-product-name="${o.productName || ''}"
                         data-product-price="${o.price || 0}"
                         data-product-quantity="${o.quantity || 0}"
                         data-product-image="${o.imagePath || '/img/placeholder.png'}">
                    <div class="order-card__info">
                        <p class="order-card__name">${o.productName}</p>
                        <p class="order-card__price">${o.price.toLocaleString()} ₽ × ${o.quantity}</p>
                    </div>`;
                listElm.appendChild(li);
            });
            const addLi = document.createElement('li');
            addLi.className = 'add-card';
            addLi.innerHTML = '<div class="add-card__plus"></div>';
            addLi.addEventListener('click', openModal);
            listElm.appendChild(addLi);
        }

        const modal = document.getElementById('modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const confirmBtn = document.getElementById('confirm-btn');
        const addBtnEmpty = document.querySelector('.no-orders');
        const selectEl = document.getElementById('product-select');
        const qtyInput = document.getElementById('qty-input');
        const totalPriceEl = document.getElementById('total-price');

        let productsCache = [];

        addBtnEmpty.addEventListener('click', openModal);
        cancelBtn.addEventListener('click', hideModal);
        selectEl.addEventListener('change', updateTotal);
        qtyInput.addEventListener('input', updateTotal);
        confirmBtn.addEventListener('click', sendAddToCart);

        async function openModal() {
            if (productsCache.length === 0) {
                try {
                    const products = await ApiHelper.get('/api/cart');
                    productsCache = products.filter(p => p.quantity > 0);
                    rebuildSelectOptions();
                } catch (e) {
                    console.error('Failed to load products:', e);
                    // ApiHelper уже показал Toast с ошибкой
                    return;
                }
            }
            
            if (!productsCache.length) {
                Toast.info('Все товары распроданы');
                return;
            }

            selectEl.selectedIndex = 0;
            qtyInput.value = '';
            updateTotal();

            modal.classList.remove('hidden');
            modal.setAttribute('aria-hidden', 'false');
            qtyInput.focus();
        }

        function hideModal() {
            modal.classList.add('hidden');
            modal.setAttribute('aria-hidden', 'true');
        }

        function rebuildSelectOptions() {
            selectEl.innerHTML = '';
            productsCache.forEach(p => {
                const text = `${p.name} — ${p.price} ₽ (остаток ${p.quantity})`;
                selectEl.add(new Option(text, p.id));
            });
        }

        function updateTotal() {
            qtyInput.value = qtyInput.value.replace(/\D/g, '');
            const id = Number(selectEl.value);
            const product = productsCache.find(p => p.id === id);
            if (!product || qtyInput.value === '') {
                totalPriceEl.textContent = 'Итого: —';
                confirmBtn.disabled = true;
                return;
            }
            let qty = Math.min(parseInt(qtyInput.value, 10), product.quantity);
            qty = Math.max(qty, 1);
            qtyInput.value = qty;
            totalPriceEl.textContent = `Итого: ${(product.price * qty).toLocaleString()} ₽`;
            confirmBtn.disabled = false;
        }

        async function sendAddToCart() {
            const id = Number(selectEl.value);
            const qty = Number(qtyInput.value);
            if (!qty) {
                return;
            }

            try {
                const cartData = await ApiHelper.post('/api/cart', {id, quantity: qty}, {
                    showSuccessToast: true,
                    successMessage: `Товар добавлен в корзину (${qty} шт.)`
                });
                
                renderOrders(cartData);

                // Обновляем кеш продуктов
                const prod = productsCache.find(p => p.id === id);
                if (prod) {
                    prod.quantity -= qty;
                    if (prod.quantity <= 0) {
                        productsCache = productsCache.filter(p => p.id !== id);
                    }
                    rebuildSelectOptions();
                }
                
                hideModal();
            } catch (e) {
                console.error('Failed to add to cart:', e);
                // ApiHelper уже показал Toast с ошибкой (включая валидационные и бизнес-ошибки)
                // Не закрываем модал при ошибке, чтобы пользователь мог исправить данные
            }
        }

        const profileModal = document.getElementById('profile-modal');
        const profCancelBtn = document.getElementById('profile-cancel');
        const profSaveBtn = document.getElementById('profile-save');
        const profTitle = document.getElementById('profile-modal-title');
        const profLabel = document.getElementById('profile-modal-label');

        let currentField = null;      // 'username' | 'email' | 'birthdate'
        let inputEl = null;

        document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', () => openEditModal(btn.dataset.field));
        });
        profCancelBtn.addEventListener('click', hideEditModal);
        profSaveBtn.addEventListener('click', saveProfileField);

        function openEditModal(field) {
            currentField = field;
            const currentValue = document
                .getElementById('profile-' + field)
                .textContent.trim();

            inputEl = document.createElement('input');
            inputEl.className = 'modal__input';
            inputEl.value = currentValue;
            inputEl.addEventListener('input', validateProfileInput);

            switch (field) {
                case 'username':
                    profTitle.textContent = 'Изменить имя';
                    inputEl.type = 'text';
                    inputEl.maxLength = 50;
                    break;
                case 'email':
                    profTitle.textContent = 'Изменить e‑mail';
                    inputEl.type = 'email';
                    break;
                case 'birthdate':
                    profTitle.textContent = 'Изменить дату рождения';
                    inputEl.type = 'date';
                    break;
            }
            profLabel.innerHTML = '';
            profLabel.appendChild(inputEl);
            validateProfileInput();
            profileModal.classList.remove('hidden');
            profileModal.setAttribute('aria-hidden', 'false');
            inputEl.focus();
        }

        function hideEditModal() {
            profileModal.classList.add('hidden');
            profileModal.setAttribute('aria-hidden', 'true');

            currentField = null;
            inputEl = null;
        }

        function validateProfileInput() {
            if (!inputEl) return;

            const v = inputEl.value.trim();
            let valid = false;

            if (currentField === 'username') {
                valid = v.length >= 2;
            } else if (currentField === 'email') {
                valid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
            } else if (currentField === 'birthdate') {
                valid = v !== '';
            }

            profSaveBtn.disabled = !valid;
        }

        async function saveProfileField() {
            if (!currentField || !inputEl) return;

            const value = inputEl.value.trim();
            const payloadKey = currentField === 'birthdate' ? 'birthDate' : currentField;
            const payload = {[payloadKey]: value};

            let apiSuccess = false;
            
            // Разделяем обработку API запроса от UI операций
            try {
                await ApiHelper.patch('/api/profile', payload, {
                    showSuccessToast: true,
                    successMessage: `${currentField === 'username' ? 'Имя успешно обновлено' : 
                                      currentField === 'email' ? 'Email успешно обновлён' : 
                                      'Дата рождения успешно обновлена'}`
                });
                apiSuccess = true;
            } catch (e) {
                console.error('Failed to save profile field:', e);
                // ApiHelper уже показал Toast с ошибкой (включая валидационные ошибки)
                // Не закрываем модал при ошибке, чтобы пользователь мог исправить данные
                return;
            }

            // Если API запрос успешен, обновляем UI и закрываем модал
            if (apiSuccess) {
                try {
                    document.getElementById('profile-' + currentField).textContent = value;
                } catch (uiError) {
                    console.error('Failed to update UI:', uiError);
                    // Даже если UI не обновился, показываем что данные сохранены
                    Toast.info('Данные сохранены. Обновите страницу для отображения изменений.');
                }
                
                // Всегда закрываем модал после успешного сохранения
                hideEditModal();
            }
        }

        // JavaScript для модалки информации о товаре
        const productModal = document.getElementById('product-info-modal');
        const productCloseBtn = document.getElementById('product-info-close');
        const productEditBtn = document.getElementById('product-edit-btn');
        const productDeleteBtn = document.getElementById('product-delete-btn');

        // JavaScript для модалки редактирования товара
        const editModal = document.getElementById('product-edit-modal');
        const editCancelBtn = document.getElementById('edit-cancel-btn');
        const editSaveBtn = document.getElementById('edit-save-btn');
        const editQtyInput = document.getElementById('edit-qty-input');
        const editTotalPrice = document.getElementById('edit-total-price');


        let currentProductData = null;

        // Добавляем делегирование событий для кликов на карточки товаров
        listElm.addEventListener('click', (e) => {
            // Найдем родительскую карточку товара
            const orderCard = e.target.closest('.order-card');
            if (orderCard) {
                const img = orderCard.querySelector('.order-card__img');
                if (img) {
                    // Извлекаем данные из data-атрибутов изображения
                    const productData = {
                        productId: img.dataset.productId,
                        productName: img.dataset.productName,
                        price: parseInt(img.dataset.productPrice),
                        quantity: parseInt(img.dataset.productQuantity),
                        imagePath: img.dataset.productImage
                    };
                    openProductModal(productData);
                }
            }
        });

        // Обработчики для модалки продукта
        productCloseBtn.addEventListener('click', hideProductModal);
        productEditBtn.addEventListener('click', editProduct);
        productDeleteBtn.addEventListener('click', deleteProduct);

        // Обработчики для модалки редактирования
        editCancelBtn.addEventListener('click', hideProductEditModal);
        editSaveBtn.addEventListener('click', saveEditedProduct);
        editQtyInput.addEventListener('input', validateEditQuantity);

        // Закрытие модалок при клике на фон
        productModal.addEventListener('click', (e) => {
            if (e.target === productModal) {
                hideProductModal();
            }
        });
        
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) {
                hideProductEditModal();
            }
        });

        function openProductModal(productData) {
            currentProductData = productData;
            
            // Заполняем данные в модалке
            document.getElementById('product-info-image').src = productData.imagePath || '/img/placeholder.png';
            document.getElementById('product-info-image').alt = productData.productName || '';
            document.getElementById('product-info-name').textContent = productData.productName || '';
            document.getElementById('product-info-price').textContent = `${(productData.price || 0).toLocaleString()} ₽`;
            document.getElementById('product-info-quantity').textContent = productData.quantity || 0;
            document.getElementById('product-info-total').textContent = `${((productData.price || 0) * (productData.quantity || 0)).toLocaleString()} ₽`;
            
            // Показываем модалку
            productModal.classList.remove('hidden');
            productModal.setAttribute('aria-hidden', 'false');
        }

        function hideProductModal() {
            productModal.classList.add('hidden');
            productModal.setAttribute('aria-hidden', 'true');
            currentProductData = null;
        }

        function editProduct() {
            if (!currentProductData || !currentProductData.productId) {
                Toast.error('Невозможно редактировать товар');
                return;
            }
            
            // Сохраняем данные ДО закрытия модалки
            const productDataToEdit = { ...currentProductData };

            hideProductModal();
            
            // Заполняем данные в модалке редактирования
            const editImageEl = document.getElementById('edit-product-image');
            const editNameEl = document.getElementById('edit-product-name');  
            const editPriceEl = document.getElementById('edit-product-price');
            
            if (editImageEl) editImageEl.src = productDataToEdit.imagePath || '/img/placeholder.png';
            if (editImageEl) editImageEl.alt = productDataToEdit.productName || '';
            if (editNameEl) editNameEl.textContent = productDataToEdit.productName || '';
            if (editPriceEl) editPriceEl.textContent = `${(productDataToEdit.price || 0).toLocaleString()} ₽`;
            
            if (editQtyInput) {
                editQtyInput.value = productDataToEdit.quantity;
                
                // Восстанавливаем currentProductData для других функций
                currentProductData = productDataToEdit;
                validateEditQuantity();
            }
            
            // Показываем модалку редактирования
            if (editModal) {
                editModal.classList.remove('hidden');
                editModal.setAttribute('aria-hidden', 'false');
                if (editQtyInput) {
                    editQtyInput.focus();
                    editQtyInput.select();
                }
            } else {
                Toast.error('Ошибка открытия модалки редактирования');
            }
        }

        function hideProductEditModal() {
            editModal.classList.add('hidden');
            editModal.setAttribute('aria-hidden', 'true');
        }

        function validateEditQuantity() {
            // Удаляем нецифровые символы
            if (editQtyInput) {
                editQtyInput.value = editQtyInput.value.replace(/\D/g, '');
            }
            
            const quantity = parseInt(editQtyInput ? editQtyInput.value : 0) || 0;
            const isValid = quantity > 0;
            
            if (isValid && currentProductData) {
                const total = currentProductData.price * quantity;
                if (editTotalPrice) {
                    editTotalPrice.textContent = `Итого: ${total.toLocaleString()} ₽`;
                }
            } else {
                if (editTotalPrice) {
                    editTotalPrice.textContent = 'Итого: —';
                }
            }
            
            if (editSaveBtn) {
                editSaveBtn.disabled = !isValid;
            }
        }

        async function saveEditedProduct() {
            if (!currentProductData || !currentProductData.productId) {
                Toast.error('Невозможно сохранить изменения');
                return;
            }

            const newQuantity = parseInt(editQtyInput.value) || 0;
            if (newQuantity <= 0) {
                Toast.error('Количество должно быть больше 0');
                return;
            }

            try {
                const cartData = await ApiHelper.patch('/api/cart', {
                    id: currentProductData.productId,
                    quantity: newQuantity
                }, {
                    showSuccessToast: true,
                    successMessage: 'Количество товара обновлено'
                });
                
                renderOrders(cartData);
                hideProductEditModal();
                
            } catch (e) {
                console.error('Failed to update product quantity:', e);
                // ApiHelper уже показал Toast с ошибкой
            }
        }

        async function deleteProduct() {
            if (!currentProductData || !currentProductData.productId) {
                Toast.error('Невозможно удалить товар');
                return;
            }

            if (!confirm(`Вы уверены, что хотите удалить "${currentProductData.productName}" из корзины?`)) {
                return;
            }

            try {
                const cartData = await ApiHelper.delete(`/api/cart/${currentProductData.productId}`, {
                    showSuccessToast: true,
                    successMessage: 'Товар удален из корзины'
                });
                
                renderOrders(cartData);
                
                // Обновляем кеш продуктов, если он был загружен
                if (productsCache.length > 0) {
                    const prod = productsCache.find(p => p.id === currentProductData.productId);
                    if (prod) {
                        prod.quantity += currentProductData.quantity;
                        rebuildSelectOptions();
                    }
                }
                
                hideProductModal();
            } catch (e) {
                console.error('Failed to delete product:', e);
                // ApiHelper уже показал Toast с ошибкой
            }
        }
    </script>
</div>
</body>
</html>
